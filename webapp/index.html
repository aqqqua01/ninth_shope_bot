<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ Steam</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-label.required::after {
            content: " *";
            color: #e74c3c;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0088cc);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }

        .form-input:invalid {
            border-color: #e74c3c;
        }

        .form-input[readonly] {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-hint-color, #999999);
            cursor: not-allowed;
        }

        .total-display {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #0088cc), #005580);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
        }

        .payment-details {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .payment-details h3 {
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .payment-details pre {
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--tg-theme-text-color, #000000);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 56px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            background: #005580;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--tg-theme-destructive-text-color, #e74c3c);
            border: 2px solid var(--tg-theme-destructive-text-color, #e74c3c);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-destructive-text-color, #e74c3c);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .currency {
            font-weight: 600;
            color: var(--tg-theme-button-color, #0088cc);
        }

        .crypto-conversion {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .crypto-conversion h3 {
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }

        .crypto-rate {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .crypto-rate:last-child {
            border-bottom: none;
        }

        .crypto-symbol {
            font-weight: 600;
            color: var(--tg-theme-button-color, #0088cc);
        }

        .crypto-amount {
            font-family: monospace;
            color: var(--tg-theme-text-color, #000000);
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ Steam</h1>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</p>
        </div>

        <form id="topupForm">
            <div class="form-group">
                <label for="steamLogin" class="form-label required">–õ–æ–≥–∏–Ω Steam</label>
                <input 
                    type="text" 
                    id="steamLogin" 
                    class="form-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω Steam"
                    required
                    autocomplete="off"
                >
                <div class="error-message" id="loginError">–õ–æ–≥–∏–Ω Steam –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>

            <div class="form-group">
                <label for="baseAmount" class="form-label required">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input 
                    type="text" 
                    id="baseAmount" 
                    class="form-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–º–∏–Ω–∏–º—É–º 100 —Ä—É–±–ª–µ–π)"
                    required
                    autocomplete="off"
                >
                <div class="error-message" id="amountError">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 100 –†–£–ë</div>
            </div>

            <div class="total-display">
                –ö –æ–ø–ª–∞—Ç–µ: <span id="totalAmount">0.00</span> <span class="currency" id="currency">–†–£–ë</span>
            </div>

            <div class="crypto-conversion" id="cryptoConversion" style="display: none;">
                <h3>üíé –í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π:</h3>
                <div id="cryptoRates"></div>
            </div>

            <div class="payment-details">
                <h3>üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:</h3>
                <pre id="paymentDetails">–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –±—É–¥—É—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏</pre>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" id="cancelBtn">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </div>
        </form>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const form = document.getElementById('topupForm');
        const steamLoginInput = document.getElementById('steamLogin');
        const baseAmountInput = document.getElementById('baseAmount');
        const totalAmountSpan = document.getElementById('totalAmount');
        const currencySpan = document.getElementById('currency');
        const paymentDetailsElement = document.getElementById('paymentDetails');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const loginError = document.getElementById('loginError');
        const amountError = document.getElementById('amountError');

        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ config.js
        const CONFIG = window.WEBAPP_CONFIG || {
            currency: '–†–£–ë',
            commissionRate: 0.15,
            defaultPaymentDetails: `–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –±—É–¥—É—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏`
        };

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∞–ª—é—Ç—É —Ç–∞ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏
        currencySpan.textContent = CONFIG.currency;
        paymentDetailsElement.textContent = CONFIG.defaultPaymentDetails;

        // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—É–º–º—ã
        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            
            // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
            const cleanAmount = amountStr.replace(',', '.').replace(/\s/g, '');
            const parsed = parseFloat(cleanAmount);
            
            return isNaN(parsed) ? 0 : Math.max(0, parsed);
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        function calculateTotal(baseAmount) {
            const total = baseAmount * (1 + CONFIG.commissionRate);
            return Math.round(total * 100) / 100; // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
        function validateForm() {
            let isValid = true;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
            const steamLogin = steamLoginInput.value.trim();
            if (!steamLogin) {
                loginError.style.display = 'block';
                steamLoginInput.style.borderColor = '#e74c3c';
                isValid = false;
            } else {
                loginError.style.display = 'none';
                steamLoginInput.style.borderColor = '';
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
            const baseAmount = parseAmount(baseAmountInput.value);
            const minAmount = CONFIG.validation?.minAmount || 100;
            if (baseAmount < minAmount) {
                amountError.textContent = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: ${minAmount} –†–£–ë`;
                amountError.style.display = 'block';
                baseAmountInput.style.borderColor = '#e74c3c';
                isValid = false;
            } else {
                amountError.style.display = 'none';
                baseAmountInput.style.borderColor = '';
            }

            return isValid;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        function updateTotal() {
            const baseAmount = parseAmount(baseAmountInput.value);
            const total = calculateTotal(baseAmount);
            
            totalAmountSpan.textContent = total.toFixed(2);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã
            if (baseAmount >= 100) {
                updateCryptoConversion(total);
            } else {
                hideCryptoConversion();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            const isFormValid = validateForm();
            submitBtn.disabled = !isFormValid;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        async function updateCryptoConversion(rubAmount) {
            // –ü—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ –∫—É—Ä—Å–∏ –∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API
            try {
                const response = await fetch('http://localhost:8002/api/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: rubAmount
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showCryptoConversion(data.conversions);
                        console.log('üî• –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –†–ï–ê–õ–¨–ù–Ü –∫—É—Ä—Å–∏ –∑ Crypto Pay API!');
                        return;
                    }
                }
            } catch (error) {
                console.log('üí° API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –ø—Ä–∏–±–ª–∏–∑–Ω—ñ –∫—É—Ä—Å–∏');
            }
            
            // Fallback –¥–æ –ø—Ä–∏–±–ª–∏–∑–Ω–∏—Ö –∫—É—Ä—Å—ñ–≤
            showFallbackCryptoRates(rubAmount);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        function showCryptoConversion(conversions) {
            const cryptoConversion = document.getElementById('cryptoConversion');
            const cryptoRates = document.getElementById('cryptoRates');
            
            cryptoRates.innerHTML = '';
            
            // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∞–ª—é—Ç
            const order = ['USDT', 'TON', 'BTC', 'ETH', 'LTC', 'BNB'];
            const sortedConversions = {};
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª—é—Ç—ã –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            order.forEach(asset => {
                if (conversions[asset]) {
                    sortedConversions[asset] = conversions[asset];
                }
            });
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            Object.keys(conversions).forEach(asset => {
                if (!sortedConversions[asset]) {
                    sortedConversions[asset] = conversions[asset];
                }
            });
            
            Object.entries(sortedConversions).forEach(([asset, data]) => {
                const rateDiv = document.createElement('div');
                rateDiv.className = 'crypto-rate';
                rateDiv.innerHTML = `
                    <span class="crypto-symbol">${asset}</span>
                    <span class="crypto-amount">${data.amount}</span>
                `;
                cryptoRates.appendChild(rateDiv);
            });
            
            cryptoConversion.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è —Å —Ç–æ—á–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏ –∏–∑ Crypto Bot (28.08.2025)
        function showFallbackCryptoRates(rubAmount) {
            // –†–µ–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –ø—Ä—è–º–æ –∏–∑ @CryptoBot
            const approximateRates = {
                'USDT': rubAmount / 79.99,        // 1 USDT = 79.99 RUB
                'TON': rubAmount / 252.55,        // 1 TON = 252.55 RUB  
                'BTC': rubAmount / 8200000,       // ~8.2M RUB –∑–∞ BTC
                'ETH': rubAmount / 352274.43,     // 1 ETH = 352274.43 RUB
                'LTC': rubAmount / 8597.99,       // 1 LTC = 8597.99 RUB
                'BNB': rubAmount / 68905.16,      // 1 BNB = 68905.16 RUB
                'TRX': rubAmount / 25.99          // 1 TRX = 25.99 RUB
            };
            
            const formattedRates = {};
            Object.entries(approximateRates).forEach(([asset, amount]) => {
                let formatted;
                if (asset === 'BTC') {
                    formatted = amount.toFixed(6);
                } else if (asset === 'ETH') {
                    formatted = amount.toFixed(4);
                } else if (asset === 'LTC' || asset === 'BNB') {
                    formatted = amount.toFixed(3);
                } else if (asset === 'TRX') {
                    formatted = amount.toFixed(1);
                } else {
                    formatted = amount.toFixed(2);
                }
                
                formattedRates[asset] = { amount: formatted };
            });
            
            showCryptoConversion(formattedRates);
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        function hideCryptoConversion() {
            document.getElementById('cryptoConversion').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        steamLoginInput.addEventListener('input', () => {
            validateForm();
            submitBtn.disabled = !validateForm();
        });

        baseAmountInput.addEventListener('input', updateTotal);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const baseAmount = parseAmount(baseAmountInput.value);
            const totalAmount = calculateTotal(baseAmount);
            
            const formData = {
                steam_login: steamLoginInput.value.trim(),
                base_amount: baseAmount,
                to_pay: totalAmount,
                currency: CONFIG.currency,
                timestamp: new Date().toISOString()
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
            tg.sendData(JSON.stringify(formData));
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
        cancelBtn.addEventListener('click', () => {
            tg.close();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
        tg.MainButton.text = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑";
        tg.MainButton.color = "#0088cc";
        
        tg.MainButton.onClick(() => {
            form.dispatchEvent(new Event('submit'));
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
        function updateMainButton() {
            if (validateForm() && parseAmount(baseAmountInput.value) > 0) {
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        steamLoginInput.addEventListener('input', updateMainButton);
        baseAmountInput.addEventListener('input', updateMainButton);

        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        tg.MainButton.hide();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        document.body.style.color = tg.themeParams.text_color || '#000000';

        console.log('Steam Top-Up WebApp –∑–∞–≥—Ä—É–∂–µ–Ω');
    </script>
</body>
</html>
